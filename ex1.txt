#include <WiFi.h>
#include <time.h>
#include "esp_sleep.h"

const char* ssid = "HUAWEI nova 5T";
const char* password = "toon12345";

const char* ntpServer = "pool.ntp.org";
const long  gmtOffset_sec = 7 * 3600;
const int   daylightOffset_sec = 0;

const int deepSleepTimeSec = 60*5; // 5นาที

RTC_DATA_ATTR bool rtcTimeSet = false;

void setup() {
  Serial.begin(115200);

  if (!rtcTimeSet) {
    Serial.println("RTC not set, connecting to WiFi and setting time from NTP...");
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
      delay(500);
      Serial.print(".");
    }
    Serial.println("");
    Serial.println("WiFi connected");

    configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
    printLocalTime();

    rtcTimeSet = true;

    WiFi.disconnect(true);
    WiFi.mode(WIFI_OFF);
  } else {
    Serial.println("RTC already set, displaying time from RTC...");
    printLocalTime();
  }

  Serial.println("Entering deep sleep for " + String(deepSleepTimeSec) + " seconds...");
  esp_sleep_enable_timer_wakeup(deepSleepTimeSec * 1000000); // หน่วยเป็นไมโครวินาที
  esp_deep_sleep_start();
}

void loop() {
}

void printLocalTime() {
  struct tm timeinfo;
  if(!getLocalTime(&timeinfo)){
    Serial.println("Failed to obtain time");
    return;
  }
  char timeString[30];
  strftime(timeString, sizeof(timeString), "%Y/%m/%d %H:%M:%S", &timeinfo);
  Serial.println(timeString);
}
